<div class="w-full h-full bg-pattern flex flex-col items-center justify-center">
  <div @fadeInRight class="card overflow-hidden w-full max-w-md" style="background-color: white;">
    <div class="p-6 pb-0 flex flex-col mt-4">
      <div class="fill-current text-center" style="display: flex; align-items: center; justify-content: center;">
        <img style="width: 50%;" src="/assets/img/logo/DashCamPay_trasparente_large.png" />
      </div>
    </div>
    <div class="text-center" style="margin-top: 7%;">
      <h2 class="title m-0">¡Bienvenido!</h2>
      <h4 class="body-2 text-secondary m-0">
        Inicia sesión con tus credenciales a continuación.
      </h4>
    </div>
    <div class="p-2 flex flex-col gap-2">
      <form [formGroup]="loginForm" (ngSubmit)="onSubmit()" class="p-6 flex flex-col gap-4" novalidate>
        <div class="flex flex-col">
          <mat-form-field class="flex-1">
            <mat-label>Correo Electrónico</mat-label>
            <input matInput formControlName="userName" type="email" autocomplete="username" required />
            <mat-error *ngIf="loginForm.get('userName')?.hasError('required')">
              Ingresa tu correo para iniciar sesión.
            </mat-error>
          </mat-form-field>
          <mat-form-field class="flex-1 mt-3">
            <mat-label>Contraseña</mat-label>
            <input matInput [type]="inputType" formControlName="password" autocomplete="current-password" required />
            <button type="button" mat-icon-button matIconSuffix (click)="toggleVisibility()">
              <mat-icon>{{ inputType === 'password' ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="loginForm.get('password')?.hasError('required')">
              Necesitamos una contraseña para iniciar sesión.
            </mat-error>
          </mat-form-field>
          <div style="display:flex; justify-content:flex-end; margin-top: -4px;">
            <button class="btn-open-otp" type="button" (click)="openOtpModal()">
              <h4 class="m-0">
                Verificar Cuenta
              </h4>
            </button>
          </div>
        </div>
        <button class="mt-2 align" type="submit" [disabled]="loginForm.invalid || loading">
          <span *ngIf="loading" class="loader"></span>
          <span style="margin-left: 3%;">{{ textLogin }}</span>
        </button>
        <div class="login-link-wrap">
          <a class="login-link" [routerLink]="['/forgot-password']">¿Olvidaste tu Contraseña?</a>
        </div>
        <div class="login-link-wrap">
          <a class="login-link" [routerLink]="['/register']">¿Aún no tienes cuenta? Regístrate</a>
        </div>
      </form>
    </div>
  </div>
</div>


<div id="otp-modal" class="modal-backdrop" [class.is-open]="otpOpen" [class.is-closing]="otpClosing">
  <div class="modal-card modal-xl" @fadeInRight>
    <div class="modal-header otp-header">
      <h3 class="otp-title">Verificación de Cuenta</h3>
      <a class="close" href="#">×</a>
    </div>
    <div class="modal-body otp-body">
      <div *ngIf="modalStep === 'email'">
        <p class="otp-subtitle">
          Ingresa tu correo electrónico para reenviar el código de verificación.
        </p>
        <form [formGroup]="emailForm" (ngSubmit)="onSendEmail()" class="otp-form">
          <div class="otp-inputs">
            <input class="otp-email" type="email" formControlName="userName" placeholder="correo@dominio.com"
              autocomplete="email" aria-label="Correo electrónico" />
          </div>
          <div class="otp-actions">
            <button class="btn-verify" type="submit" [disabled]="emailForm.invalid || loading">
              Enviar Correo
            </button>
            <button type="button" class="btn-close-otp" (click)="closeOtpModal()">
              Cerrar
            </button>
          </div>
        </form>
      </div>
      <div *ngIf="modalStep === 'otp'">
        <p class="otp-subtitle">
          Nos alegra que estés aquí. Para terminar el registro, ingresa el código de <strong>4 dígitos</strong> que te
          enviamos a tu correo.
        </p>
        <form [formGroup]="verifyForm" (ngSubmit)="onVerify()" class="otp-form">
          <div class="otp-inputs">
            <input #otpInput class="otp-box otp-elev" maxlength="1" inputmode="numeric" pattern="[0-9]*"
              aria-label="Dígito 1" (input)="onOtpInput($event,0)" (keydown)="onOtpKeydown($event,0)" />
            <input #otpInput class="otp-box otp-elev" maxlength="1" inputmode="numeric" pattern="[0-9]*"
              aria-label="Dígito 2" (input)="onOtpInput($event,1)" (keydown)="onOtpKeydown($event,1)" />
            <input #otpInput class="otp-box otp-elev" maxlength="1" inputmode="numeric" pattern="[0-9]*"
              aria-label="Dígito 3" (input)="onOtpInput($event,2)" (keydown)="onOtpKeydown($event,2)" />
            <input #otpInput class="otp-box otp-elev" maxlength="1" inputmode="numeric" pattern="[0-9]*"
              aria-label="Dígito 4" (input)="onOtpInput($event,3)" (keydown)="onOtpKeydown($event,3)" />
          </div>
          <div class="otp-actions">
            <button class="btn-verify" type="submit" [disabled]="verifyForm.invalid || loading">
              Verificar
            </button>
            <button class="link-resend" type="button" (click)="onResend()" [disabled]="resendDisabled || loading">
              Reenviar código <span *ngIf="resendDisabled">({{ resendSeconds }}s)</span>
            </button>
            <button type="button" class="btn-close-otp" (click)="closeOtpModal()">
              Cerrar
            </button>
          </div>
          <p *ngIf="resendMsg" @fadeInRight class="resend-note">
            {{ resendMsg }}
          </p>
          <p class="otp-footnote">
            ¿No recibiste el correo? Revisa tu carpeta de spam o solicita reenviar.
          </p>
        </form>
      </div>
    </div>
  </div>
</div>